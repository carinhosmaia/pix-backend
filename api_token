import express from "express";
import axios from "axios";
import cors from "cors";
import dotenv from "dotenv";

dotenv.config();

const app = express();
app.use(cors({ origin: "*" }));
app.use(express.json());

const ACCESS_TOKEN = process.env.INVICTUS_API_TOKEN;

app.post("/criar-pix", async (req, res) => {
  try {
    const response = await axios.post(
      "https://api.invictuspay.com.br/api/public/v1/transactions",
      {
        transaction_amount: 14.87,
        payment_method_id: "pix",
        payer: {
          email: "comprador@teste.com"
        }
      },
      {
        headers: {
          Authorization: `Bearer ${ACCESS_TOKEN}`,
          "Content-Type": "application/json"
        }
      }
    );

    const pix =
      response.data?.point_of_interaction?.transaction_data;

    res.json({
      payment_id: response.data.id,
      qr_code: pix.qr_code,
      qr_base64: pix.qr_code_base64
    });

  } catch (e) {
    console.error("ERRO COMPLETO:", e.response?.data || e.message);
    res.status(500).json({
      error: "Erro ao criar PIX",
      detalhe: e.response?.data || e.message
    });
  }
});

app.listen(3000, () => {
  console.log("Backend PIX rodando");
});
